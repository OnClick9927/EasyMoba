BattlePlayMode = {
    Normal = 1,
    Local = 2,
    Recorder = 4,
}

---@type ModeServer
local mode_server
local room_id
local role_id
---@type FrameHandler
local frame_handler


Battle = {}
Battle.ScenePart = require("Battle.Scene.ScenePart")
Battle.players = nil


---@param battle_mode any
---@param room string
---@param players number[]
function Battle.StartGame(battle_mode, room, players)
    Battle.players = players
    room_id = room
    role_id = Models.PlayerModel:GetRoleID()
    local r
    if battle_mode == BattlePlayMode.Local then
        r = require "Battle.Mode.LocalModeServer"
    elseif battle_mode == BattlePlayMode.Recorder then
        r = require "Battle.Mode.RecordModeServer"
    elseif battle_mode == BattlePlayMode.Normal then
        r = require "Battle.Mode.NormalModeServer"
    end
    mode_server = r()
    frame_handler = require("Battle.FrameHandler")()
    Battle.scene_part.LoadScene()
end

function Battle.CloseGame()
    mode_server:Dispose()
    frame_handler = nil
end

---@param data SPBattleFrame
function Battle.OnBattelFrame(data)
    frame_handler:OnBattelFrame(data)
end

---@param frame number
---@param op_tab BattleOp
function Battle.SendBattleFrame(frame, op_tab)
    NetEvents.NewJsonObject(op_tab)
    local op = Json:encode(op_tab)
    mode_server:SendBattleFrame(room_id, role_id, frame, op)
end
